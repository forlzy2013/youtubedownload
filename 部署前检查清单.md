# 部署前检查清单

## ✅ 环境变量检查结果

你的环境变量配置已经**完全正确**！所有必需的配置都已就绪。

---

## 📋 配置摘要

### ✅ RapidAPI 配置
- **API Key:** ✅ 已配置（2411876baa...22fec）
- **API Host 1:** ✅ youtube-mp36.p.rapidapi.com
- **API Host 2:** ✅ youtube-mp3-2025.p.rapidapi.com
- **API Host 3:** ✅ youtube-info-download-api.p.rapidapi.com

### ✅ Upstash Redis 配置
- **REST URL:** ✅ https://amazed-quagga-6163.upstash.io
- **REST Token:** ✅ 已配置（ARgTAAImcD...jE2Mw）

### ✅ Cloudflare R2 配置
- **Endpoint:** ✅ https://92e41f3c8ef664503660f8fb563d604.r2.cloudflarestorage.com
- **Access Key ID:** ✅ 已配置（e869fc7504...598f9）
- **Secret Access Key:** ✅ 已配置（b34670109e...d8b69）
- **Bucket Name:** ✅ youtube-mp3-downloads
- **Public URL:** ✅ https://pub-26a6e40311764f32b576bbb68ff6f8ba.r2.dev

### ✅ Render 配置
- **API Key:** ✅ 已配置（rnd_MboxR4...HNRy4）
- **Worker URL:** ✅ https://youtube-mp3-worker.onrender.com

### ✅ API 配额设置
- **API 1 月配额:** 300
- **API 2 月配额:** 300
- **API 3 日配额:** 2000

---

## 🚀 准备部署

### 第一步：最后检查

运行检查脚本确认一切正常：

```bash
npm run check
```

### 第二步：开始部署

```bash
npm run deploy
```

这个命令会自动：
1. ✅ 检查所有环境变量
2. ✅ 登录 Vercel（首次需要浏览器授权）
3. ✅ 部署前端和 API 到 Vercel
4. ✅ 通过 Render API 创建 Worker 服务
5. ✅ 配置所有环境变量到 Render
6. ✅ 显示部署结果和下一步操作

---

## ⏱️ 预计时间

- **Vercel 部署:** 2-3 分钟
- **Render 服务创建:** 1 分钟
- **Render 首次构建:** 5-10 分钟（后台进行）

**总计:** 约 3-4 分钟（不包括 Render 构建时间）

---

## 📝 部署后需要做的事

部署脚本完成后，会显示详细的下一步操作。主要包括：

### 1. 更新 Vercel 环境变量（重要！）

Render Worker 部署后会生成一个 URL，你需要：

1. 访问 https://vercel.com/dashboard
2. 选择你的项目
3. 进入 Settings → Environment Variables
4. 更新 `RENDER_WORKER_URL` 为实际的 Render URL
5. 重新部署 Vercel

### 2. 设置 CRON 任务（防止休眠）

1. 访问 https://cron-job.org
2. 注册/登录
3. 创建新任务：
   - URL: `https://youtube-mp3-worker.onrender.com/health`
   - 频率: `*/10 * * * *` (每 10 分钟)
   - 时区: UTC
4. 保存并启用

### 3. 等待 Render 构建完成

- 首次部署需要 5-10 分钟
- 可以在 Render 控制台查看进度
- 构建完成后服务会自动启动

### 4. 测试部署

```bash
# 等待 Render 构建完成后运行
npm run test:e2e
```

---

## 🔍 验证部署

### 检查 Vercel

访问你的 Vercel URL（部署后会显示），应该看到：
- ✅ 项目首页正常显示
- ✅ 可以输入 YouTube URL
- ✅ 点击 "Analyze" 按钮有响应

### 检查 Render Worker

```bash
# 测试健康检查（等待构建完成后）
curl https://youtube-mp3-worker.onrender.com/health

# 应该返回：
# {"status":"ok","uptime":123,"timestamp":1234567890,"queueSize":0}
```

### 检查 Redis 连接

```bash
# 测试 Redis
curl -H "Authorization: Bearer ARgTAAImcDJlZmFkODdiNTE3NTg0ODcwOGUwNmJkZDY1MGNjNzczY3AyNjE2Mw" \
  https://amazed-quagga-6163.upstash.io/ping

# 应该返回：
# {"result":"PONG"}
```

---

## ⚠️ 注意事项

### 1. Render 首次部署较慢

- 需要构建 Docker 镜像
- 安装 yt-dlp 和 ffmpeg
- 首次可能需要 5-10 分钟
- 这是正常的，请耐心等待

### 2. Vercel 首次登录

- 运行 `npm run deploy` 时
- 如果未登录 Vercel，会打开浏览器
- 授权后会自动继续部署

### 3. 环境变量更新

- 部署后记得更新 Vercel 的 `RENDER_WORKER_URL`
- 否则 Fast Track 失败后无法切换到 Stable Track

### 4. CRON 任务很重要

- 不设置 CRON，Render 会在 15 分钟后休眠
- 首次请求需要 30-60 秒唤醒
- 设置后响应时间 <5 秒

---

## 🎯 成功标志

部署成功后，你应该能够：

- ✅ 访问 Vercel URL 看到项目首页
- ✅ 输入 YouTube URL 并获取视频信息
- ✅ 点击下载按钮开始下载
- ✅ Fast Track 在 3-5 秒内完成
- ✅ Stable Track 在 30-60 秒内完成
- ✅ 下载历史正常保存
- ✅ 所有功能正常工作

---

## 🆘 遇到问题？

### 常见问题

1. **Vercel 登录失败**
   ```bash
   vercel logout
   vercel login
   ```

2. **Render API 返回 401**
   - 检查 RENDER_API_KEY 是否正确
   - 确保 API Key 以 `rnd_` 开头

3. **环境变量缺失**
   - 运行 `npm run check` 再次检查
   - 确保 `.env.local` 和 `worker/.env` 都已配置

4. **部署失败**
   - 查看错误信息
   - 检查网络连接
   - 确认所有 API Key 都有效

### 获取帮助

1. 查看 [TROUBLESHOOTING.md](TROUBLESHOOTING.md)
2. 查看 [新手部署指南.md](新手部署指南.md)
3. 查看部署日志中的错误信息

---

## ✅ 最终检查清单

部署前确认：

- [x] Node.js 20+ 已安装
- [x] Vercel CLI 已安装
- [x] `.env.local` 已配置所有变量
- [x] `worker/.env` 已配置
- [x] 所有 API Key 都有效
- [x] 网络连接正常
- [x] 运行 `npm run check` 通过

**一切就绪！现在可以运行：**

```bash
npm run deploy
```

---

**祝部署顺利！** 🚀

如果遇到任何问题，请查看错误信息并参考故障排除文档。
