# 新手部署指南 - 一键自动化部署

## 🎯 目标

使用自动化脚本，一键部署到 Vercel 和 Render，无需手动在网页上操作。

---

## 📋 准备工作（只需做一次）

### 1. 安装必需软件

#### Windows 用户：
```powershell
# 安装 Node.js 20+
# 下载: https://nodejs.org/

# 验证安装
node --version
npm --version
```

#### Mac/Linux 用户：
```bash
# 使用 nvm 安装 Node.js
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 20
nvm use 20
```

### 2. 安装 Vercel CLI

```bash
npm install -g vercel
```

### 3. 获取 API 密钥

#### 3.1 RapidAPI Key
1. 访问 https://rapidapi.com/
2. 注册/登录账号
3. 订阅以下 3 个 API（免费版）：
   - youtube-mp36
   - youtube-mp3-2025
   - youtube-info-download-api
4. 复制你的 API Key

#### 3.2 Upstash Redis
1. 访问 https://console.upstash.com/
2. 创建 Redis 数据库
3. 复制 REST URL 和 REST TOKEN

#### 3.3 Cloudflare R2
1. 访问 https://dash.cloudflare.com/
2. 创建 R2 bucket: `youtube-mp3-downloads`
3. 生成 API Token
4. 复制 Endpoint, Access Key, Secret Key, Public URL

#### 3.4 Render API Key
1. 访问 https://dashboard.render.com/account/api-keys
2. 创建新的 API Key
3. 复制 API Key（格式：rnd_xxxxx）

### 4. 配置环境变量

#### 4.1 创建 `.env.local` 文件

复制 `.env.example` 并重命名为 `.env.local`，然后填入真实值：

```bash
# RapidAPI配置
RAPIDAPI_KEY=你的_RapidAPI_密钥
RAPIDAPI_HOST_1=youtube-mp36.p.rapidapi.com
RAPIDAPI_HOST_2=youtube-mp3-2025.p.rapidapi.com
RAPIDAPI_HOST_3=youtube-info-download-api.p.rapidapi.com

# Upstash Redis配置
UPSTASH_REDIS_REST_URL=https://你的-redis.upstash.io
UPSTASH_REDIS_REST_TOKEN=你的_Redis_Token

# Cloudflare R2配置
R2_ENDPOINT=https://你的账户ID.r2.cloudflarestorage.com
R2_ACCESS_KEY_ID=你的_R2_Access_Key
R2_SECRET_ACCESS_KEY=你的_R2_Secret_Key
R2_BUCKET_NAME=youtube-mp3-downloads
R2_PUBLIC_URL=https://pub-你的ID.r2.dev

# Render Worker URL（首次部署后会自动生成）
RENDER_WORKER_URL=https://youtube-mp3-worker.onrender.com

# Render API Key（用于自动化部署）
RENDER_API_KEY=rnd_你的_Render_API_Key

# API配额限制
RAPIDAPI_1_MONTHLY_QUOTA=300
RAPIDAPI_2_MONTHLY_QUOTA=300
RAPIDAPI_3_DAILY_QUOTA=500
```

#### 4.2 创建 `worker/.env` 文件

复制 `worker/.env.example` 并重命名为 `worker/.env`，填入相同的值：

```bash
# Upstash Redis配置
UPSTASH_REDIS_REST_URL=https://你的-redis.upstash.io
UPSTASH_REDIS_REST_TOKEN=你的_Redis_Token

# Cloudflare R2配置
R2_ENDPOINT=https://你的账户ID.r2.cloudflarestorage.com
R2_ACCESS_KEY_ID=你的_R2_Access_Key
R2_SECRET_ACCESS_KEY=你的_R2_Secret_Key
R2_BUCKET_NAME=youtube-mp3-downloads
R2_PUBLIC_URL=https://pub-你的ID.r2.dev

# 任务配置
MAX_CONCURRENT_TASKS=3
TASK_TIMEOUT=120000
```

---

## 🚀 一键部署

### 方法 1: 使用自动化脚本（推荐）

```bash
# 1. 安装项目依赖
npm install

# 2. 运行一键部署脚本
npm run deploy
```

脚本会自动：
1. ✅ 检查环境变量
2. ✅ 登录 Vercel（首次需要授权）
3. ✅ 部署前端和 API 到 Vercel
4. ✅ 创建 Render Worker 服务
5. ✅ 配置所有环境变量
6. ✅ 显示部署结果和下一步操作

### 方法 2: 分步部署

```bash
# 只部署 Vercel
npm run deploy:vercel

# 只部署 Render
npm run deploy:render
```

---

## 📝 部署后的操作

### 1. 更新 Vercel 环境变量

部署完成后，脚本会显示 Render Worker 的 URL，例如：
```
https://youtube-mp3-worker.onrender.com
```

你需要：
1. 访问 https://vercel.com/dashboard
2. 选择你的项目
3. 进入 Settings → Environment Variables
4. 添加或更新：
   ```
   RENDER_WORKER_URL = https://youtube-mp3-worker.onrender.com
   ```
5. 点击 Save
6. 重新部署 Vercel（在 Deployments 页面点击 Redeploy）

### 2. 设置 CRON 任务（防止 Render 休眠）

1. 访问 https://cron-job.org
2. 注册/登录账号
3. 创建新的 CRON 任务：
   - **Title:** Keep Render Worker Alive
   - **URL:** `https://youtube-mp3-worker.onrender.com/health`
   - **Schedule:** `*/10 * * * *` (每 10 分钟)
   - **Timezone:** UTC
4. 保存并启用

### 3. 等待 Render 首次构建

Render 首次部署需要 5-10 分钟来：
- 构建 Docker 镜像
- 安装 yt-dlp 和 ffmpeg
- 启动服务

你可以在 Render 控制台查看构建日志：
https://dashboard.render.com/

### 4. 测试部署

等待 Render 构建完成后，运行测试：

```bash
# 设置测试 URL
export BASE_URL=https://你的项目.vercel.app
export WORKER_URL=https://youtube-mp3-worker.onrender.com

# 运行端到端测试
npm run test:e2e
```

---

## 🔍 验证部署

### 检查 Vercel

1. 访问你的 Vercel URL
2. 应该看到项目首页
3. 尝试输入 YouTube URL 并点击 "Analyze"

### 检查 Render Worker

```bash
# 测试健康检查
curl https://youtube-mp3-worker.onrender.com/health

# 应该返回：
# {"status":"ok","uptime":123,"timestamp":1234567890,"queueSize":0}
```

### 检查 Redis

```bash
# 测试 Redis 连接
curl -H "Authorization: Bearer 你的_REDIS_TOKEN" \
  https://你的-redis.upstash.io/ping

# 应该返回：
# {"result":"PONG"}
```

---

## 🛠️ 常见问题

### Q1: Vercel 部署失败

**错误:** `Error: No token found`

**解决:**
```bash
vercel logout
vercel login
```

### Q2: Render API 返回 401

**错误:** `Unauthorized`

**解决:**
1. 检查 RENDER_API_KEY 是否正确
2. 确保 API Key 没有过期
3. 重新生成 API Key

### Q3: 环境变量缺失

**错误:** `Missing required environment variable: XXX`

**解决:**
1. 检查 `.env.local` 文件是否存在
2. 确保所有必需的变量都已填写
3. 变量值不要有多余的空格或引号

### Q4: Render 服务已存在

**提示:** `Service already exists`

**解决:**
这是正常的。如果服务已存在，脚本会跳过创建。
如需重新部署，在 Render 控制台手动触发部署。

### Q5: 首次访问很慢

**原因:** Render 免费版会在 15 分钟不活动后休眠

**解决:**
1. 确保 CRON 任务已设置并运行
2. 首次访问等待 30-60 秒让服务唤醒
3. CRON 任务运行后，响应会很快

---

## 📊 部署成本

所有服务都使用免费版：

| 服务 | 免费额度 | 月成本 |
|------|---------|--------|
| Vercel | 100GB 带宽, 1M 函数调用 | $0 |
| Render | 750 小时/月 | $0 |
| RapidAPI | 900 请求/月（3个API） | $0 |
| Upstash Redis | 300K 请求/月 | $0 |
| Cloudflare R2 | 10GB 存储, 10M 读取 | $0 |
| cron-job.org | 无限任务 | $0 |

**总计: $0/月** 🎉

---

## 🎯 下一步

部署完成后：

1. ✅ 测试所有功能
2. ✅ 分享给团队成员
3. ✅ 设置监控和告警
4. ✅ 定期检查 API 配额使用情况

---

## 📞 需要帮助？

1. 查看 [TROUBLESHOOTING.md](TROUBLESHOOTING.md)
2. 查看 [DEPLOYMENT.md](DEPLOYMENT.md)
3. 查看自动化部署日志

---

**祝部署顺利！** 🚀
