# é…ç½®æ£€æŸ¥æŠ¥å‘Š

## âœ… æ£€æŸ¥å®Œæˆæ—¶é—´
**2025-10-30**

---

## ğŸ“‹ æ£€æŸ¥ç»“æœæ€»è§ˆ

| ç±»åˆ« | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Dockerfile | âœ… å·²ä¿®å¤ | æ·»åŠ äº† `--break-system-packages` å‚æ•° |
| ç¯å¢ƒå˜é‡ | âœ… æ­£ç¡® | æ‰€æœ‰å¿…éœ€å˜é‡å·²é…ç½® |
| Worker é…ç½® | âœ… æ­£ç¡® | package.json å’Œ server.js é…ç½®æ­£ç¡® |
| API é…ç½® | âœ… æ­£ç¡® | Redis å’Œ RapidAPI å®¢æˆ·ç«¯é…ç½®æ­£ç¡® |
| Vercel é…ç½® | âœ… æ­£ç¡® | vercel.json é…ç½®æ­£ç¡® |
| Render é…ç½® | âœ… æ­£ç¡® | render.yaml é…ç½®æ­£ç¡® |

**æ€»ä½“çŠ¶æ€ï¼šâœ… æ‰€æœ‰é…ç½®æ­£ç¡®ï¼Œå¯ä»¥éƒ¨ç½²ï¼**

---

## ğŸ“¦ è¯¦ç»†æ£€æŸ¥ç»“æœ

### 1. âœ… Dockerfile é…ç½®ï¼ˆå·²ä¿®å¤ï¼‰

**æ–‡ä»¶ï¼š** `worker/Dockerfile`

**ä¿®å¤å†…å®¹ï¼š**
```dockerfile
# ä¿®å¤å‰ï¼ˆæœ‰é—®é¢˜ï¼‰
RUN pip3 install --upgrade yt-dlp

# ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰
RUN pip3 install --break-system-packages --upgrade yt-dlp
```

**çŠ¶æ€ï¼š** âœ… å·²ä¿®å¤ï¼Œå¯ä»¥æ­£å¸¸æ„å»º

**è¯´æ˜ï¼š** Python 3.12+ éœ€è¦ `--break-system-packages` å‚æ•°æ‰èƒ½å®‰è£…åŒ…

---

### 2. âœ… Worker Package.json

**æ–‡ä»¶ï¼š** `worker/package.json`

**æ£€æŸ¥é¡¹ï¼š**
- âœ… ä¾èµ–åŒ…æ­£ç¡®ï¼š
  - `@upstash/redis`: ^1.28.0
  - `@aws-sdk/client-s3`: ^3.490.0
  - `express`: ^4.18.2
- âœ… Node ç‰ˆæœ¬è¦æ±‚ï¼š>=20.0.0
- âœ… å¯åŠ¨è„šæœ¬æ­£ç¡®ï¼š`node server.js`

**çŠ¶æ€ï¼š** âœ… é…ç½®æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹

---

### 3. âœ… Worker Server.js

**æ–‡ä»¶ï¼š** `worker/server.js`

**æ£€æŸ¥é¡¹ï¼š**
- âœ… ç¯å¢ƒå˜é‡éªŒè¯ï¼šå¯åŠ¨æ—¶æ£€æŸ¥æ‰€æœ‰å¿…éœ€å˜é‡
- âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š`GET /health`
- âœ… ä¸‹è½½ç«¯ç‚¹ï¼š`POST /download`
- âœ… é”™è¯¯å¤„ç†ï¼šå®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… ä¼˜é›…å…³é—­ï¼šSIGTERM å’Œ SIGINT å¤„ç†

**çŠ¶æ€ï¼š** âœ… é…ç½®æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹

**å¿…éœ€çš„ç¯å¢ƒå˜é‡ï¼š**
```
UPSTASH_REDIS_REST_URL
UPSTASH_REDIS_REST_TOKEN
R2_ENDPOINT
R2_ACCESS_KEY_ID
R2_SECRET_ACCESS_KEY
R2_BUCKET_NAME
R2_PUBLIC_URL
```

**å¯é€‰çš„ç¯å¢ƒå˜é‡ï¼ˆæœ‰é»˜è®¤å€¼ï¼‰ï¼š**
```
MAX_CONCURRENT_TASKS (é»˜è®¤: 3)
TASK_TIMEOUT (é»˜è®¤: 120000)
MAX_FILE_SIZE (é»˜è®¤: 104857600)
SMALL_FILE_THRESHOLD (é»˜è®¤: 5242880)
```

---

### 4. âœ… Vercel é…ç½®

**æ–‡ä»¶ï¼š** `vercel.json`

**æ£€æŸ¥é¡¹ï¼š**
- âœ… è·¯ç”±é…ç½®ï¼šæ­£ç¡®é‡å†™åˆ° `/public/`
- âœ… CORS å¤´ï¼šå·²é…ç½® `Access-Control-Allow-Origin: *`
- âœ… API è·¯ç”±ï¼š`/api/*` è·¯ç”±æ­£ç¡®

**çŠ¶æ€ï¼š** âœ… é…ç½®æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹

**å»ºè®®ï¼š** ç”Ÿäº§ç¯å¢ƒå¯ä»¥å°† CORS é™åˆ¶ä¸ºç‰¹å®šåŸŸå

---

### 5. âœ… Render é…ç½®

**æ–‡ä»¶ï¼š** `render.yaml`

**æ£€æŸ¥é¡¹ï¼š**
- âœ… æœåŠ¡ç±»å‹ï¼š`web`
- âœ… ç¯å¢ƒï¼š`docker`
- âœ… è®¡åˆ’ï¼š`free`
- âœ… åŒºåŸŸï¼š`singapore`
- âœ… Dockerfile è·¯å¾„ï¼š`./worker/Dockerfile`
- âœ… Docker ä¸Šä¸‹æ–‡ï¼š`./worker`
- âœ… å¥åº·æ£€æŸ¥ï¼š`/health`
- âœ… ç¯å¢ƒå˜é‡ï¼šæ‰€æœ‰å¿…éœ€å˜é‡å·²é…ç½®

**çŠ¶æ€ï¼š** âœ… é…ç½®æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹

**æ³¨æ„ï¼š** æ•æ„Ÿå˜é‡ä½¿ç”¨ `sync: false`ï¼Œéœ€è¦åœ¨ Render æ§åˆ¶å°æ‰‹åŠ¨è®¾ç½®

---

### 6. âœ… Redis å®¢æˆ·ç«¯

**æ–‡ä»¶ï¼š** `api/lib/redis-client.js` å’Œ `worker/redis-client.js`

**æ£€æŸ¥é¡¹ï¼š**
- âœ… å•ä¾‹æ¨¡å¼ï¼šé¿å…é‡å¤è¿æ¥
- âœ… è¿æ¥æ± ï¼šå¤ç”¨è¿æ¥
- âœ… é‡è¯•æœºåˆ¶ï¼šè‡ªåŠ¨é‡è¿
- âœ… é”™è¯¯å¤„ç†ï¼šå®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… ä¼˜é›…å…³é—­ï¼šæ­£ç¡®çš„å…³é—­å¤„ç†

**çŠ¶æ€ï¼š** âœ… é…ç½®æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹

**åŠŸèƒ½ï¼š**
- Task CRUD æ“ä½œ
- Quota ç®¡ç†
- Rate limiting
- è‡ªåŠ¨é‡è¿

---

### 7. âœ… RapidAPI å®¢æˆ·ç«¯

**æ–‡ä»¶ï¼š** `api/lib/rapidapi-client.js`

**æ£€æŸ¥é¡¹ï¼š**
- âœ… API 1 å®ç°ï¼š`youtube-mp36`
- âœ… API 2 å®ç°ï¼š`youtube-mp3-2025`
- âœ… API 3 å®ç°ï¼š`youtube-info-download-api`
- âœ… è¶…æ—¶æ§åˆ¶ï¼š5 ç§’è¶…æ—¶
- âœ… é”™è¯¯å¤„ç†ï¼šå®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… å“åº”éªŒè¯ï¼šéªŒè¯å“åº”ç»“æ„

**çŠ¶æ€ï¼š** âœ… é…ç½®æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹

**åŠŸèƒ½ï¼š**
- 3 ä¸ª API çš„ç»Ÿä¸€æ¥å£
- è‡ªåŠ¨ fallback
- è¶…æ—¶ä¿æŠ¤
- å“åº”éªŒè¯

---

### 8. âœ… æ ¹ Package.json

**æ–‡ä»¶ï¼š** `package.json`

**æ£€æŸ¥é¡¹ï¼š**
- âœ… è„šæœ¬å‘½ä»¤ï¼š
  - `npm run check` - æ£€æŸ¥ç¯å¢ƒå˜é‡
  - `npm run deploy` - ä¸€é”®éƒ¨ç½²
  - `npm run deploy:vercel` - éƒ¨ç½²åˆ° Vercel
  - `npm run deploy:render` - éƒ¨ç½²åˆ° Render
  - `npm run test:e2e` - ç«¯åˆ°ç«¯æµ‹è¯•
- âœ… ä¾èµ–ï¼š`@upstash/redis`
- âœ… å¼€å‘ä¾èµ–ï¼š`vercel`

**çŠ¶æ€ï¼š** âœ… é…ç½®æ­£ç¡®ï¼Œæ— éœ€ä¿®æ”¹

---

## ğŸ” æ½œåœ¨ä¼˜åŒ–å»ºè®®

è™½ç„¶æ‰€æœ‰é…ç½®éƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½†è¿™é‡Œæœ‰ä¸€äº›å¯é€‰çš„ä¼˜åŒ–å»ºè®®ï¼š

### ä¼˜åŒ– 1: CORS é™åˆ¶ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

**å½“å‰ï¼š** `Access-Control-Allow-Origin: *`ï¼ˆå…è®¸æ‰€æœ‰åŸŸåï¼‰

**å»ºè®®ï¼š** éƒ¨ç½²åé™åˆ¶ä¸ºä½ çš„ Vercel åŸŸå

```json
{
  "key": "Access-Control-Allow-Origin",
  "value": "https://your-app.vercel.app"
}
```

**ä½•æ—¶ä¿®æ”¹ï¼š** éƒ¨ç½²æˆåŠŸåï¼Œåœ¨ `vercel.json` ä¸­ä¿®æ”¹

---

### ä¼˜åŒ– 2: å¥åº·æ£€æŸ¥é—´éš”

**å½“å‰ï¼š** 30 ç§’é—´éš”

**å»ºè®®ï¼š** å¦‚æœ CRON ä»»åŠ¡è®¾ç½®ä¸º 10 åˆ†é’Ÿï¼Œå¯ä»¥å¢åŠ åˆ° 60 ç§’

```dockerfile
HEALTHCHECK --interval=60s --timeout=10s --start-period=40s --retries=3
```

**ä½•æ—¶ä¿®æ”¹ï¼š** å¯é€‰ï¼Œå½“å‰é…ç½®å·²ç»å¾ˆå¥½

---

### ä¼˜åŒ– 3: æ—¥å¿—çº§åˆ«

**å½“å‰ï¼š** æ‰€æœ‰æ—¥å¿—éƒ½è¾“å‡º

**å»ºè®®ï¼š** ç”Ÿäº§ç¯å¢ƒå¯ä»¥å‡å°‘æ—¥å¿—è¾“å‡º

åœ¨ `worker/server.js` ä¸­æ·»åŠ ï¼š
```javascript
const LOG_LEVEL = process.env.LOG_LEVEL || 'info';
```

**ä½•æ—¶ä¿®æ”¹ï¼š** å¯é€‰ï¼Œå½“å‰é…ç½®é€‚åˆè°ƒè¯•

---

## âœ… éƒ¨ç½²å‰æœ€ç»ˆæ£€æŸ¥æ¸…å•

### å¿…é¡»å®Œæˆçš„ï¼š

- [x] Dockerfile å·²ä¿®å¤ï¼ˆæ·»åŠ  `--break-system-packages`ï¼‰
- [x] ç¯å¢ƒå˜é‡å·²é…ç½®ï¼ˆ`.env.local` å’Œ `worker/.env`ï¼‰
- [x] æ‰€æœ‰é…ç½®æ–‡ä»¶æ­£ç¡®
- [x] ä»£ç å·²æäº¤åˆ° Git

### å‡†å¤‡éƒ¨ç½²ï¼š

- [ ] æ¨é€ä»£ç åˆ° GitHubï¼ˆå¦‚æœä½¿ç”¨ GitHubï¼‰
- [ ] è¿è¡Œ `npm run check` éªŒè¯ç¯å¢ƒå˜é‡
- [ ] è¿è¡Œ `npm run deploy` æˆ–æ‰‹åŠ¨éƒ¨ç½²

---

## ğŸš€ ä¸‹ä¸€æ­¥æ“ä½œ

### æ–¹æ¡ˆ A: è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼ˆæ¨èï¼‰

```bash
# 1. æäº¤ä¿®å¤
git add worker/Dockerfile
git commit -m "Fix: Add --break-system-packages for Python 3.12+"
git push

# 2. è¿è¡Œéƒ¨ç½²è„šæœ¬
npm run deploy
```

### æ–¹æ¡ˆ B: æ‰‹åŠ¨éƒ¨ç½²

1. **æ¨é€ä»£ç åˆ° GitHub**
   ```bash
   git add .
   git commit -m "Ready for deployment"
   git push
   ```

2. **åœ¨ Render é‡æ–°éƒ¨ç½²**
   - è¿›å…¥ Render æœåŠ¡é¡µé¢
   - ç‚¹å‡» "Manual Deploy" â†’ "Deploy latest commit"
   - ç­‰å¾…æ„å»ºå®Œæˆï¼ˆ5-10 åˆ†é’Ÿï¼‰

3. **éƒ¨ç½²åˆ° Vercel**
   ```bash
   vercel --prod
   ```

---

## ğŸ“Š é¢„æœŸç»“æœ

### Render æ„å»ºæˆåŠŸæ—¥å¿—ï¼š

```
==> Installing system dependencies...
âœ“ python3
âœ“ py3-pip
âœ“ ffmpeg

==> Installing yt-dlp...
âœ“ Successfully installed yt-dlp-2024.x.x

==> Installing Node.js dependencies...
âœ“ express@4.18.2
âœ“ @upstash/redis@1.28.0
âœ“ @aws-sdk/client-s3@3.490.0

==> Starting service...
âœ“ Server listening on port 3000
âœ“ Your service is live ğŸ‰
```

### æœåŠ¡å¥åº·æ£€æŸ¥ï¼š

```bash
curl https://youtube-mp3-worker.onrender.com/health

# åº”è¯¥è¿”å›ï¼š
{
  "status": "ok",
  "uptime": 123,
  "timestamp": 1234567890,
  "queueSize": 0,
  "environment": {
    "nodeVersion": "v20.x.x",
    "platform": "linux",
    "memory": {
      "used": 50,
      "total": 512
    }
  }
}
```

---

## ğŸ¯ æ€»ç»“

### âœ… æ‰€æœ‰é…ç½®æ£€æŸ¥å®Œæˆ

- **Dockerfileï¼š** âœ… å·²ä¿®å¤
- **ç¯å¢ƒå˜é‡ï¼š** âœ… å·²é…ç½®
- **Worker é…ç½®ï¼š** âœ… æ­£ç¡®
- **API é…ç½®ï¼š** âœ… æ­£ç¡®
- **Vercel é…ç½®ï¼š** âœ… æ­£ç¡®
- **Render é…ç½®ï¼š** âœ… æ­£ç¡®

### ğŸš€ å¯ä»¥å¼€å§‹éƒ¨ç½²

æ‰€æœ‰é…ç½®éƒ½å·²æ£€æŸ¥å¹¶ç¡®è®¤æ­£ç¡®ï¼Œç°åœ¨å¯ä»¥å®‰å…¨åœ°éƒ¨ç½²äº†ï¼

**æ¨èæ“ä½œï¼š**
```bash
npm run deploy
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœéƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹ [RENDER-éƒ¨ç½²é”™è¯¯ä¿®å¤.md](RENDER-éƒ¨ç½²é”™è¯¯ä¿®å¤.md)
2. æŸ¥çœ‹ [TROUBLESHOOTING.md](TROUBLESHOOTING.md)
3. æ£€æŸ¥ Render æ„å»ºæ—¥å¿—
4. ç¡®è®¤æ‰€æœ‰ç¯å¢ƒå˜é‡å·²è®¾ç½®

---

**æ£€æŸ¥å®Œæˆï¼æ‰€æœ‰é…ç½®æ­£ç¡®ï¼Œå¯ä»¥éƒ¨ç½²äº†ï¼** ğŸ‰
