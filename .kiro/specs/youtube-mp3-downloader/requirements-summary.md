# 需求文档总结

## 📋 文档状态

- **创建日期:** 2025-10-29
- **最后更新:** 2025-10-29
- **状态:** ✅ 已完成,等待用户审核
- **版本:** 2.0 (已更新API配置)

---

## 🎯 核心需求概览

### 功能需求 (13个)

1. **URL输入和验证** - 支持多种YouTube URL格式
2. **视频分析** - 2秒内获取视频元数据
3. **下载启动** - 一键下载MP3
4. **智能API选择** - 加权随机选择,优先使用高额度API
5. **稳定通道降级** - 所有API失败后转Render Worker
6. **异步任务处理** - 轮询任务状态,显示进度
7. **Worker视频处理** - yt-dlp + ffmpeg转换
8. **下载历史** - 本地存储最近50条记录
9. **错误处理** - 友好的错误提示和重试
10. **响应式设计** - 支持手机/平板/桌面
11. **性能优化** - 快速通道<5秒,异步任务<60秒
12. **成本管理** - 月成本<$5 (实际$0)
13. **健康监控** - 检查所有依赖服务状态

### 风险缓解需求 (6个)

14. **冷启动防护** - CRON定时Ping,防止Render休眠
15. **API配额管理** - 实时跟踪,80%告警,100%切换
16. **请求频率限制** - 每IP每分钟5次,防YouTube封禁
17. **任务超时处理** - 120秒上限,自动终止
18. **任务过期处理** - 24小时TTL,友好提示
19. **错误重试机制** - 网络错误重试1次

---

## 🏗️ 技术架构

### 四层架构

```
┌─────────────────────────────────────────┐
│  前端层 (Vercel Static)                  │
│  - HTML/CSS/JavaScript                  │
│  - 响应式设计                            │
│  - 本地存储历史记录                      │
└────────────────┬────────────────────────┘
                 ↓
┌─────────────────────────────────────────┐
│  API层 (Vercel Serverless Functions)    │
│  - /api/video-info (视频信息)           │
│  - /api/download (智能路由)             │
│  - /api/task-status (任务状态)          │
│  - /api/health (健康检查)               │
└────────────────┬────────────────────────┘
                 ↓
        ┌────────┴────────┐
        ↓                 ↓
┌──────────────┐  ┌──────────────────┐
│ 快速通道      │  │ 稳定通道          │
│ (RapidAPI)   │  │ (Render Worker)  │
│              │  │                  │
│ API 1: 10%   │  │ yt-dlp + ffmpeg  │
│ API 2: 10%   │  │ 异步任务处理      │
│ API 3: 80%   │  │ 30-60秒响应      │
│ 3-5秒响应    │  │                  │
└──────────────┘  └──────────────────┘
                         ↓
                ┌────────────────┐
                │ Upstash Redis  │
                │ (任务状态存储)  │
                │ 24小时TTL      │
                └────────────────┘
```

---

## 📊 关键指标

### 性能指标

| 指标 | 目标 | 预期 |
|------|------|------|
| 快速通道响应时间 | <5秒 | 3-5秒 ✅ |
| 异步任务响应时间 | <60秒 | 30-60秒 ✅ |
| 视频信息获取时间 | <2秒 | 1-2秒 ✅ |
| 任务状态查询时间 | <1秒 | <1秒 ✅ |
| 快速通道覆盖率 | >80% | 80% ✅ |
| 总体成功率 | >95% | 97%+ ✅ |

### 成本指标

| 服务 | 免费额度 | 预期使用 | 成本 |
|------|---------|---------|------|
| RapidAPI 1 | 300次/月 | 300次/月 | $0 ✅ |
| RapidAPI 2 | 300次/月 | 300次/月 | $0 ✅ |
| RapidAPI 3 | 500次/天 | 2400次/月 | $0 ✅ |
| Render | 750小时/月 | 720小时/月 | $0 ✅ |
| Vercel | 100GB流量 | <5GB | $0 ✅ |
| Upstash | 300K次/月 | 10K次/月 | $0 ✅ |
| **总计** | - | - | **$0/月** ✅ |

---

## 🔄 智能路由策略

### 加权随机选择

```
初始权重:
- API 1: 10% (300次/月额度)
- API 2: 10% (300次/月额度)
- API 3: 80% (500次/天额度,最高)

动态调整:
- 当API配额达80% → 权重降为0%
- 当API配额达100% → 跳过该API
- 所有API耗尽 → 直接转Render Worker
```

### 降级流程

```
1. 加权随机选择主API (例如API 3)
2. 尝试主API (5秒超时)
   ├─ 成功 → 返回下载链接 ✅
   └─ 失败 ↓
3. 尝试API 1 (5秒超时)
   ├─ 成功 → 返回下载链接 ✅
   └─ 失败 ↓
4. 尝试API 2 (5秒超时)
   ├─ 成功 → 返回下载链接 ✅
   └─ 失败 ↓
5. 创建Render Worker任务
   └─ 30-60秒后完成 ✅
```

---

## 🛡️ 风险缓解措施

### 1. 冷启动问题
- **风险:** Render Worker休眠导致首次请求慢
- **缓解:** cron-job.org每10分钟Ping
- **效果:** 响应时间稳定在30-60秒

### 2. API配额耗尽
- **风险:** 超出免费额度导致付费
- **缓解:** 实时监控 + 80%告警 + 智能分配
- **效果:** 完全在免费额度内

### 3. YouTube封禁
- **风险:** 请求频率过高被封IP
- **缓解:** 每IP每分钟5次限制
- **效果:** 风险降低到最低

### 4. 任务超时
- **风险:** 长视频处理时间过长
- **缓解:** 120秒超时 + 自动终止 + 重试按钮
- **效果:** 用户体验良好

### 5. 数据过期
- **风险:** 24小时后任务数据丢失
- **缓解:** 404检测 + 友好提示 + 重新下载按钮
- **效果:** 用户理解并可轻松重试

### 6. 网络错误
- **风险:** 临时网络问题导致失败
- **缓解:** 自动重试1次 (2秒延迟)
- **效果:** 成功率提升5-10%

---

## ✅ EARS合规性

所有19个需求均遵循EARS模式:

- **Ubiquitous (普遍性):** THE <system> SHALL <response>
- **Event-driven (事件驱动):** WHEN <trigger>, THE <system> SHALL <response>
- **State-driven (状态驱动):** WHILE <condition>, THE <system> SHALL <response>
- **Unwanted event (异常事件):** IF <condition>, THEN THE <system> SHALL <response>
- **Complex (复合):** WHERE/WHILE/WHEN/IF组合

所有需求均符合INCOSE质量规则:
- ✅ 主动语态
- ✅ 无模糊术语
- ✅ 无逃避条款
- ✅ 无否定陈述
- ✅ 单一思想
- ✅ 明确可测量
- ✅ 一致术语
- ✅ 无代词
- ✅ 无绝对词
- ✅ 关注"做什么"而非"怎么做"

---

## 📝 下一步

**当前阶段:** 需求审核

**待办事项:**
1. ⏳ 用户审核需求文档
2. ⏳ 确认所有需求完整且准确
3. ⏳ 进入设计阶段

**用户需要确认的问题:**
1. 19个需求是否覆盖了所有功能?
2. 智能API选择策略是否合理?
3. 风险缓解措施是否充分?
4. 性能和成本目标是否可接受?

**一旦批准,将进入设计阶段:**
- 详细的架构设计
- 组件接口定义
- 数据模型设计
- 错误处理策略
- 测试策略
