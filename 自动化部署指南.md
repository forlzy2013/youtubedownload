# è‡ªåŠ¨åŒ–éƒ¨ç½²æŒ‡å—

## æ¦‚è¿°

æœ¬æŒ‡å—å°†å¸®åŠ©ä½ ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·è‡ªåŠ¨åŒ–éƒ¨ç½²åˆ° Vercel å’Œ Renderï¼Œæ— éœ€æ‰‹åŠ¨åœ¨ç½‘é¡µä¸Šæ“ä½œã€‚

---

## æ–¹æ¡ˆ 1: ä½¿ç”¨ Vercel CLI å’Œ Render CLI

### å‰ç½®å‡†å¤‡

#### 1. å®‰è£… Node.js
ç¡®ä¿å·²å®‰è£… Node.js 20+ï¼š
```bash
node --version
```

#### 2. å®‰è£… Vercel CLI
```bash
npm install -g vercel
```

#### 3. å®‰è£… Render CLI
```bash
npm install -g @render/cli
```

---

## ç¬¬ä¸€æ­¥ï¼šè‡ªåŠ¨éƒ¨ç½²åˆ° Vercel

### 1.1 ç™»å½• Vercel

```bash
vercel login
```

è¿™ä¼šæ‰“å¼€æµè§ˆå™¨è®©ä½ æˆæƒã€‚

### 1.2 åˆ›å»ºè‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

åˆ›å»º `deploy-vercel.sh`ï¼ˆæˆ– `deploy-vercel.ps1` for Windowsï¼‰ï¼š

```bash
#!/bin/bash

echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° Vercel..."

# è¯»å–ç¯å¢ƒå˜é‡
source .env.local

# éƒ¨ç½²åˆ° Vercel
vercel --prod \
  --yes \
  --env RAPIDAPI_KEY="$RAPIDAPI_KEY" \
  --env RAPIDAPI_HOST_1="$RAPIDAPI_HOST_1" \
  --env RAPIDAPI_HOST_2="$RAPIDAPI_HOST_2" \
  --env RAPIDAPI_HOST_3="$RAPIDAPI_HOST_3" \
  --env UPSTASH_REDIS_REST_URL="$UPSTASH_REDIS_REST_URL" \
  --env UPSTASH_REDIS_REST_TOKEN="$UPSTASH_REDIS_REST_TOKEN" \
  --env RENDER_WORKER_URL="$RENDER_WORKER_URL" \
  --env RAPIDAPI_1_MONTHLY_QUOTA="300" \
  --env RAPIDAPI_2_MONTHLY_QUOTA="300" \
  --env RAPIDAPI_3_DAILY_QUOTA="500"

echo "âœ… Vercel éƒ¨ç½²å®Œæˆï¼"
```

### 1.3 ä½¿ç”¨ Vercel API è‡ªåŠ¨åŒ–ï¼ˆæ›´é«˜çº§ï¼‰

åˆ›å»º `deploy-vercel-api.js`ï¼š

```javascript
const https = require('https');
const fs = require('fs');

// ä» .env.local è¯»å–é…ç½®
require('dotenv').config({ path: '.env.local' });

const VERCEL_TOKEN = process.env.VERCEL_TOKEN; // éœ€è¦åœ¨ Vercel è·å–
const PROJECT_NAME = 'youtube-mp3-downloader';

async function deployToVercel() {
  console.log('ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° Vercel...');

  // 1. åˆ›å»ºé¡¹ç›®ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  const createProject = {
    name: PROJECT_NAME,
    framework: 'other',
    environmentVariables: [
      { key: 'RAPIDAPI_KEY', value: process.env.RAPIDAPI_KEY, target: ['production'] },
      { key: 'RAPIDAPI_HOST_1', value: process.env.RAPIDAPI_HOST_1, target: ['production'] },
      { key: 'RAPIDAPI_HOST_2', value: process.env.RAPIDAPI_HOST_2, target: ['production'] },
      { key: 'RAPIDAPI_HOST_3', value: process.env.RAPIDAPI_HOST_3, target: ['production'] },
      { key: 'UPSTASH_REDIS_REST_URL', value: process.env.UPSTASH_REDIS_REST_URL, target: ['production'] },
      { key: 'UPSTASH_REDIS_REST_TOKEN', value: process.env.UPSTASH_REDIS_REST_TOKEN, target: ['production'] },
      { key: 'RENDER_WORKER_URL', value: process.env.RENDER_WORKER_URL, target: ['production'] },
      { key: 'RAPIDAPI_1_MONTHLY_QUOTA', value: '300', target: ['production'] },
      { key: 'RAPIDAPI_2_MONTHLY_QUOTA', value: '300', target: ['production'] },
      { key: 'RAPIDAPI_3_DAILY_QUOTA', value: '500', target: ['production'] }
    ]
  };

  // è°ƒç”¨ Vercel API
  // è¯¦ç»†å®ç°è§ä¸‹æ–‡
  
  console.log('âœ… Vercel éƒ¨ç½²å®Œæˆï¼');
}

deployToVercel();
```

---

## ç¬¬äºŒæ­¥ï¼šè‡ªåŠ¨éƒ¨ç½²åˆ° Render

### 2.1 è·å– Render API Key

1. è®¿é—® https://dashboard.render.com/account/api-keys
2. åˆ›å»ºæ–°çš„ API Key
3. ä¿å­˜åˆ° `.env.local`ï¼š
```bash
RENDER_API_KEY=rnd_xxxxxxxxxxxxx
```

### 2.2 åˆ›å»ºè‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

åˆ›å»º `deploy-render.sh`ï¼š

```bash
#!/bin/bash

echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° Render..."

# è¯»å–ç¯å¢ƒå˜é‡
source .env.local
source worker/.env

# ä½¿ç”¨ Render API åˆ›å»ºæœåŠ¡
curl -X POST https://api.render.com/v1/services \
  -H "Authorization: Bearer $RENDER_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "web_service",
    "name": "youtube-mp3-worker",
    "env": "docker",
    "region": "singapore",
    "plan": "free",
    "dockerfilePath": "./worker/Dockerfile",
    "dockerContext": "./worker",
    "envVars": [
      {
        "key": "UPSTASH_REDIS_REST_URL",
        "value": "'"$UPSTASH_REDIS_REST_URL"'"
      },
      {
        "key": "UPSTASH_REDIS_REST_TOKEN",
        "value": "'"$UPSTASH_REDIS_REST_TOKEN"'"
      },
      {
        "key": "R2_ENDPOINT",
        "value": "'"$R2_ENDPOINT"'"
      },
      {
        "key": "R2_ACCESS_KEY_ID",
        "value": "'"$R2_ACCESS_KEY_ID"'"
      },
      {
        "key": "R2_SECRET_ACCESS_KEY",
        "value": "'"$R2_SECRET_ACCESS_KEY"'"
      },
      {
        "key": "R2_BUCKET_NAME",
        "value": "'"$R2_BUCKET_NAME"'"
      },
      {
        "key": "R2_PUBLIC_URL",
        "value": "'"$R2_PUBLIC_URL"'"
      },
      {
        "key": "MAX_CONCURRENT_TASKS",
        "value": "3"
      },
      {
        "key": "TASK_TIMEOUT",
        "value": "120000"
      }
    ]
  }'

echo "âœ… Render éƒ¨ç½²å®Œæˆï¼"
```

### 2.3 ä½¿ç”¨ Node.js è„šæœ¬ï¼ˆæ¨èï¼‰

åˆ›å»º `deploy-render.js`ï¼š

```javascript
const https = require('https');
const fs = require('fs');

// ä» .env.local è¯»å–é…ç½®
require('dotenv').config({ path: '.env.local' });
require('dotenv').config({ path: 'worker/.env' });

const RENDER_API_KEY = process.env.RENDER_API_KEY;

async function deployToRender() {
  console.log('ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° Render...');

  const serviceConfig = {
    type: 'web_service',
    name: 'youtube-mp3-worker',
    env: 'docker',
    region: 'singapore',
    plan: 'free',
    dockerfilePath: './worker/Dockerfile',
    dockerContext: './worker',
    healthCheckPath: '/health',
    envVars: [
      { key: 'NODE_ENV', value: 'production' },
      { key: 'UPSTASH_REDIS_REST_URL', value: process.env.UPSTASH_REDIS_REST_URL },
      { key: 'UPSTASH_REDIS_REST_TOKEN', value: process.env.UPSTASH_REDIS_REST_TOKEN },
      { key: 'R2_ENDPOINT', value: process.env.R2_ENDPOINT },
      { key: 'R2_ACCESS_KEY_ID', value: process.env.R2_ACCESS_KEY_ID },
      { key: 'R2_SECRET_ACCESS_KEY', value: process.env.R2_SECRET_ACCESS_KEY },
      { key: 'R2_BUCKET_NAME', value: process.env.R2_BUCKET_NAME },
      { key: 'R2_PUBLIC_URL', value: process.env.R2_PUBLIC_URL },
      { key: 'MAX_CONCURRENT_TASKS', value: '3' },
      { key: 'TASK_TIMEOUT', value: '120000' },
      { key: 'PORT', value: '3000' }
    ]
  };

  const options = {
    hostname: 'api.render.com',
    path: '/v1/services',
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${RENDER_API_KEY}`,
      'Content-Type': 'application/json'
    }
  };

  return new Promise((resolve, reject) => {
    const req = https.request(options, (res) => {
      let data = '';
      
      res.on('data', (chunk) => {
        data += chunk;
      });
      
      res.on('end', () => {
        if (res.statusCode === 201) {
          console.log('âœ… Render æœåŠ¡åˆ›å»ºæˆåŠŸï¼');
          const service = JSON.parse(data);
          console.log(`æœåŠ¡ URL: ${service.service.serviceDetails.url}`);
          resolve(service);
        } else {
          console.error('âŒ éƒ¨ç½²å¤±è´¥:', data);
          reject(new Error(data));
        }
      });
    });

    req.on('error', (error) => {
      console.error('âŒ è¯·æ±‚å¤±è´¥:', error);
      reject(error);
    });

    req.write(JSON.stringify(serviceConfig));
    req.end();
  });
}

deployToRender().catch(console.error);
```

---

## ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºä¸€é”®éƒ¨ç½²è„šæœ¬

### 3.1 å®Œæ•´çš„è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

åˆ›å»º `deploy-all.js`ï¼š

```javascript
#!/usr/bin/env node

const { execSync } = require('child_process');
const fs = require('fs');
const https = require('https');

// åŠ è½½ç¯å¢ƒå˜é‡
require('dotenv').config({ path: '.env.local' });
require('dotenv').config({ path: 'worker/.env' });

console.log('ğŸš€ YouTube MP3 Downloader - è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥å…·\n');

// æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
function checkEnvVars() {
  console.log('ğŸ“‹ æ£€æŸ¥ç¯å¢ƒå˜é‡...');
  
  const required = [
    'RAPIDAPI_KEY',
    'UPSTASH_REDIS_REST_URL',
    'UPSTASH_REDIS_REST_TOKEN',
    'R2_ENDPOINT',
    'R2_ACCESS_KEY_ID',
    'R2_SECRET_ACCESS_KEY',
    'R2_BUCKET_NAME',
    'R2_PUBLIC_URL'
  ];

  const missing = required.filter(key => !process.env[key]);
  
  if (missing.length > 0) {
    console.error('âŒ ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡:');
    missing.forEach(key => console.error(`   - ${key}`));
    console.error('\nè¯·åœ¨ .env.local å’Œ worker/.env ä¸­é…ç½®è¿™äº›å˜é‡');
    process.exit(1);
  }
  
  console.log('âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡\n');
}

// éƒ¨ç½²åˆ° Vercel
async function deployVercel() {
  console.log('ğŸ“¦ éƒ¨ç½²åˆ° Vercel...');
  
  try {
    // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    try {
      execSync('vercel whoami', { stdio: 'ignore' });
    } catch {
      console.log('è¯·å…ˆç™»å½• Vercel:');
      execSync('vercel login', { stdio: 'inherit' });
    }

    // éƒ¨ç½²
    const result = execSync('vercel --prod --yes', { 
      encoding: 'utf-8',
      env: {
        ...process.env,
        RAPIDAPI_KEY: process.env.RAPIDAPI_KEY,
        RAPIDAPI_HOST_1: process.env.RAPIDAPI_HOST_1,
        RAPIDAPI_HOST_2: process.env.RAPIDAPI_HOST_2,
        RAPIDAPI_HOST_3: process.env.RAPIDAPI_HOST_3,
        UPSTASH_REDIS_REST_URL: process.env.UPSTASH_REDIS_REST_URL,
        UPSTASH_REDIS_REST_TOKEN: process.env.UPSTASH_REDIS_REST_TOKEN,
        RENDER_WORKER_URL: process.env.RENDER_WORKER_URL || 'https://youtube-mp3-worker.onrender.com',
        RAPIDAPI_1_MONTHLY_QUOTA: '300',
        RAPIDAPI_2_MONTHLY_QUOTA: '300',
        RAPIDAPI_3_DAILY_QUOTA: '500'
      }
    });

    const urlMatch = result.match(/https:\/\/[^\s]+/);
    const deployUrl = urlMatch ? urlMatch[0] : 'Unknown';
    
    console.log('âœ… Vercel éƒ¨ç½²æˆåŠŸï¼');
    console.log(`   URL: ${deployUrl}\n`);
    
    return deployUrl;
  } catch (error) {
    console.error('âŒ Vercel éƒ¨ç½²å¤±è´¥:', error.message);
    throw error;
  }
}

// éƒ¨ç½²åˆ° Render
async function deployRender() {
  console.log('ğŸ“¦ éƒ¨ç½²åˆ° Render...');
  
  const RENDER_API_KEY = process.env.RENDER_API_KEY;
  
  if (!RENDER_API_KEY) {
    console.error('âŒ ç¼ºå°‘ RENDER_API_KEY');
    console.error('è¯·è®¿é—® https://dashboard.render.com/account/api-keys è·å– API Key');
    throw new Error('Missing RENDER_API_KEY');
  }

  const serviceConfig = {
    type: 'web_service',
    name: 'youtube-mp3-worker',
    env: 'docker',
    region: 'singapore',
    plan: 'free',
    dockerfilePath: './worker/Dockerfile',
    dockerContext: './worker',
    healthCheckPath: '/health',
    envVars: [
      { key: 'NODE_ENV', value: 'production' },
      { key: 'UPSTASH_REDIS_REST_URL', value: process.env.UPSTASH_REDIS_REST_URL },
      { key: 'UPSTASH_REDIS_REST_TOKEN', value: process.env.UPSTASH_REDIS_REST_TOKEN },
      { key: 'R2_ENDPOINT', value: process.env.R2_ENDPOINT },
      { key: 'R2_ACCESS_KEY_ID', value: process.env.R2_ACCESS_KEY_ID },
      { key: 'R2_SECRET_ACCESS_KEY', value: process.env.R2_SECRET_ACCESS_KEY },
      { key: 'R2_BUCKET_NAME', value: process.env.R2_BUCKET_NAME },
      { key: 'R2_PUBLIC_URL', value: process.env.R2_PUBLIC_URL },
      { key: 'MAX_CONCURRENT_TASKS', value: '3' },
      { key: 'TASK_TIMEOUT', value: '120000' },
      { key: 'PORT', value: '3000' }
    ]
  };

  return new Promise((resolve, reject) => {
    const data = JSON.stringify(serviceConfig);
    
    const options = {
      hostname: 'api.render.com',
      path: '/v1/services',
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${RENDER_API_KEY}`,
        'Content-Type': 'application/json',
        'Content-Length': data.length
      }
    };

    const req = https.request(options, (res) => {
      let responseData = '';
      
      res.on('data', (chunk) => {
        responseData += chunk;
      });
      
      res.on('end', () => {
        if (res.statusCode === 201) {
          const service = JSON.parse(responseData);
          console.log('âœ… Render éƒ¨ç½²æˆåŠŸï¼');
          console.log(`   æœåŠ¡ ID: ${service.service.id}`);
          console.log(`   æœåŠ¡ URL: ${service.service.serviceDetails.url}\n`);
          resolve(service.service.serviceDetails.url);
        } else if (res.statusCode === 409) {
          console.log('â„¹ï¸  æœåŠ¡å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º');
          console.log('   URL: https://youtube-mp3-worker.onrender.com\n');
          resolve('https://youtube-mp3-worker.onrender.com');
        } else {
          console.error('âŒ Render éƒ¨ç½²å¤±è´¥:', responseData);
          reject(new Error(responseData));
        }
      });
    });

    req.on('error', (error) => {
      console.error('âŒ è¯·æ±‚å¤±è´¥:', error.message);
      reject(error);
    });

    req.write(data);
    req.end();
  });
}

// ä¸»å‡½æ•°
async function main() {
  try {
    // 1. æ£€æŸ¥ç¯å¢ƒå˜é‡
    checkEnvVars();

    // 2. éƒ¨ç½²åˆ° Vercel
    const vercelUrl = await deployVercel();

    // 3. éƒ¨ç½²åˆ° Render
    const renderUrl = await deployRender();

    // 4. æ˜¾ç¤ºæ€»ç»“
    console.log('ğŸ‰ éƒ¨ç½²å®Œæˆï¼\n');
    console.log('ğŸ“ éƒ¨ç½²ä¿¡æ¯:');
    console.log(`   Frontend (Vercel): ${vercelUrl}`);
    console.log(`   Worker (Render):   ${renderUrl}`);
    console.log('\nâš ï¸  ä¸‹ä¸€æ­¥:');
    console.log('   1. æ›´æ–° Vercel ç¯å¢ƒå˜é‡ RENDER_WORKER_URL ä¸º:', renderUrl);
    console.log('   2. åœ¨ cron-job.org è®¾ç½® CRON ä»»åŠ¡');
    console.log('   3. æµ‹è¯•éƒ¨ç½²: npm run test:e2e');

  } catch (error) {
    console.error('\nâŒ éƒ¨ç½²å¤±è´¥:', error.message);
    process.exit(1);
  }
}

// è¿è¡Œ
main();
```

### 3.2 æ·»åŠ åˆ° package.json

```json
{
  "scripts": {
    "deploy": "node deploy-all.js",
    "deploy:vercel": "vercel --prod",
    "deploy:render": "node deploy-render.js",
    "test:e2e": "bash test-e2e.sh"
  },
  "devDependencies": {
    "dotenv": "^16.0.0"
  }
}
```

---

## ä½¿ç”¨æ–¹æ³•

### ä¸€é”®éƒ¨ç½²

```bash
# å®‰è£…ä¾èµ–
npm install

# è¿è¡Œè‡ªåŠ¨åŒ–éƒ¨ç½²
npm run deploy
```

### åˆ†æ­¥éƒ¨ç½²

```bash
# åªéƒ¨ç½² Vercel
npm run deploy:vercel

# åªéƒ¨ç½² Render
npm run deploy:render
```

---

## æ–¹æ¡ˆ 2: ä½¿ç”¨ GitHub Actionsï¼ˆå¦‚æœä½ æ”¹å˜ä¸»æ„ï¼‰

åˆ›å»º `.github/workflows/deploy.yml`ï¼š

```yaml
name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-vercel:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

  deploy-render:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Render
        run: |
          curl -X POST https://api.render.com/deploy/srv-xxx
```

---

## æ•…éšœæ’é™¤

### Vercel CLI é—®é¢˜

```bash
# é‡æ–°ç™»å½•
vercel logout
vercel login

# æ¸…é™¤ç¼“å­˜
rm -rf .vercel
```

### Render API é—®é¢˜

```bash
# æµ‹è¯• API Key
curl -H "Authorization: Bearer $RENDER_API_KEY" \
  https://api.render.com/v1/services

# æŸ¥çœ‹ç°æœ‰æœåŠ¡
curl -H "Authorization: Bearer $RENDER_API_KEY" \
  https://api.render.com/v1/services | jq
```

---

## æ€»ç»“

ä½¿ç”¨è¿™äº›è„šæœ¬ï¼Œä½ å¯ä»¥ï¼š

1. âœ… ä¸€é”®éƒ¨ç½²åˆ° Vercel å’Œ Render
2. âœ… è‡ªåŠ¨é…ç½®æ‰€æœ‰ç¯å¢ƒå˜é‡
3. âœ… æ— éœ€æ‰‹åŠ¨åœ¨ç½‘é¡µä¸Šæ“ä½œ
4. âœ… å¯ä»¥é›†æˆåˆ° CI/CD æµç¨‹

**æ¨èä½¿ç”¨:** `deploy-all.js` è„šæœ¬ï¼Œæœ€ç®€å•æœ€å¯é ï¼
