# 自动化部署指南

## 概述

本指南将帮助你使用命令行工具自动化部署到 Vercel 和 Render，无需手动在网页上操作。

---

## 方案 1: 使用 Vercel CLI 和 Render CLI

### 前置准备

#### 1. 安装 Node.js
确保已安装 Node.js 20+：
```bash
node --version
```

#### 2. 安装 Vercel CLI
```bash
npm install -g vercel
```

#### 3. 安装 Render CLI
```bash
npm install -g @render/cli
```

---

## 第一步：自动部署到 Vercel

### 1.1 登录 Vercel

```bash
vercel login
```

这会打开浏览器让你授权。

### 1.2 创建自动化部署脚本

创建 `deploy-vercel.sh`（或 `deploy-vercel.ps1` for Windows）：

```bash
#!/bin/bash

echo "🚀 开始部署到 Vercel..."

# 读取环境变量
source .env.local

# 部署到 Vercel
vercel --prod \
  --yes \
  --env RAPIDAPI_KEY="$RAPIDAPI_KEY" \
  --env RAPIDAPI_HOST_1="$RAPIDAPI_HOST_1" \
  --env RAPIDAPI_HOST_2="$RAPIDAPI_HOST_2" \
  --env RAPIDAPI_HOST_3="$RAPIDAPI_HOST_3" \
  --env UPSTASH_REDIS_REST_URL="$UPSTASH_REDIS_REST_URL" \
  --env UPSTASH_REDIS_REST_TOKEN="$UPSTASH_REDIS_REST_TOKEN" \
  --env RENDER_WORKER_URL="$RENDER_WORKER_URL" \
  --env RAPIDAPI_1_MONTHLY_QUOTA="300" \
  --env RAPIDAPI_2_MONTHLY_QUOTA="300" \
  --env RAPIDAPI_3_DAILY_QUOTA="500"

echo "✅ Vercel 部署完成！"
```

### 1.3 使用 Vercel API 自动化（更高级）

创建 `deploy-vercel-api.js`：

```javascript
const https = require('https');
const fs = require('fs');

// 从 .env.local 读取配置
require('dotenv').config({ path: '.env.local' });

const VERCEL_TOKEN = process.env.VERCEL_TOKEN; // 需要在 Vercel 获取
const PROJECT_NAME = 'youtube-mp3-downloader';

async function deployToVercel() {
  console.log('🚀 开始部署到 Vercel...');

  // 1. 创建项目（如果不存在）
  const createProject = {
    name: PROJECT_NAME,
    framework: 'other',
    environmentVariables: [
      { key: 'RAPIDAPI_KEY', value: process.env.RAPIDAPI_KEY, target: ['production'] },
      { key: 'RAPIDAPI_HOST_1', value: process.env.RAPIDAPI_HOST_1, target: ['production'] },
      { key: 'RAPIDAPI_HOST_2', value: process.env.RAPIDAPI_HOST_2, target: ['production'] },
      { key: 'RAPIDAPI_HOST_3', value: process.env.RAPIDAPI_HOST_3, target: ['production'] },
      { key: 'UPSTASH_REDIS_REST_URL', value: process.env.UPSTASH_REDIS_REST_URL, target: ['production'] },
      { key: 'UPSTASH_REDIS_REST_TOKEN', value: process.env.UPSTASH_REDIS_REST_TOKEN, target: ['production'] },
      { key: 'RENDER_WORKER_URL', value: process.env.RENDER_WORKER_URL, target: ['production'] },
      { key: 'RAPIDAPI_1_MONTHLY_QUOTA', value: '300', target: ['production'] },
      { key: 'RAPIDAPI_2_MONTHLY_QUOTA', value: '300', target: ['production'] },
      { key: 'RAPIDAPI_3_DAILY_QUOTA', value: '500', target: ['production'] }
    ]
  };

  // 调用 Vercel API
  // 详细实现见下文
  
  console.log('✅ Vercel 部署完成！');
}

deployToVercel();
```

---

## 第二步：自动部署到 Render

### 2.1 获取 Render API Key

1. 访问 https://dashboard.render.com/account/api-keys
2. 创建新的 API Key
3. 保存到 `.env.local`：
```bash
RENDER_API_KEY=rnd_xxxxxxxxxxxxx
```

### 2.2 创建自动化部署脚本

创建 `deploy-render.sh`：

```bash
#!/bin/bash

echo "🚀 开始部署到 Render..."

# 读取环境变量
source .env.local
source worker/.env

# 使用 Render API 创建服务
curl -X POST https://api.render.com/v1/services \
  -H "Authorization: Bearer $RENDER_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "web_service",
    "name": "youtube-mp3-worker",
    "env": "docker",
    "region": "singapore",
    "plan": "free",
    "dockerfilePath": "./worker/Dockerfile",
    "dockerContext": "./worker",
    "envVars": [
      {
        "key": "UPSTASH_REDIS_REST_URL",
        "value": "'"$UPSTASH_REDIS_REST_URL"'"
      },
      {
        "key": "UPSTASH_REDIS_REST_TOKEN",
        "value": "'"$UPSTASH_REDIS_REST_TOKEN"'"
      },
      {
        "key": "R2_ENDPOINT",
        "value": "'"$R2_ENDPOINT"'"
      },
      {
        "key": "R2_ACCESS_KEY_ID",
        "value": "'"$R2_ACCESS_KEY_ID"'"
      },
      {
        "key": "R2_SECRET_ACCESS_KEY",
        "value": "'"$R2_SECRET_ACCESS_KEY"'"
      },
      {
        "key": "R2_BUCKET_NAME",
        "value": "'"$R2_BUCKET_NAME"'"
      },
      {
        "key": "R2_PUBLIC_URL",
        "value": "'"$R2_PUBLIC_URL"'"
      },
      {
        "key": "MAX_CONCURRENT_TASKS",
        "value": "3"
      },
      {
        "key": "TASK_TIMEOUT",
        "value": "120000"
      }
    ]
  }'

echo "✅ Render 部署完成！"
```

### 2.3 使用 Node.js 脚本（推荐）

创建 `deploy-render.js`：

```javascript
const https = require('https');
const fs = require('fs');

// 从 .env.local 读取配置
require('dotenv').config({ path: '.env.local' });
require('dotenv').config({ path: 'worker/.env' });

const RENDER_API_KEY = process.env.RENDER_API_KEY;

async function deployToRender() {
  console.log('🚀 开始部署到 Render...');

  const serviceConfig = {
    type: 'web_service',
    name: 'youtube-mp3-worker',
    env: 'docker',
    region: 'singapore',
    plan: 'free',
    dockerfilePath: './worker/Dockerfile',
    dockerContext: './worker',
    healthCheckPath: '/health',
    envVars: [
      { key: 'NODE_ENV', value: 'production' },
      { key: 'UPSTASH_REDIS_REST_URL', value: process.env.UPSTASH_REDIS_REST_URL },
      { key: 'UPSTASH_REDIS_REST_TOKEN', value: process.env.UPSTASH_REDIS_REST_TOKEN },
      { key: 'R2_ENDPOINT', value: process.env.R2_ENDPOINT },
      { key: 'R2_ACCESS_KEY_ID', value: process.env.R2_ACCESS_KEY_ID },
      { key: 'R2_SECRET_ACCESS_KEY', value: process.env.R2_SECRET_ACCESS_KEY },
      { key: 'R2_BUCKET_NAME', value: process.env.R2_BUCKET_NAME },
      { key: 'R2_PUBLIC_URL', value: process.env.R2_PUBLIC_URL },
      { key: 'MAX_CONCURRENT_TASKS', value: '3' },
      { key: 'TASK_TIMEOUT', value: '120000' },
      { key: 'PORT', value: '3000' }
    ]
  };

  const options = {
    hostname: 'api.render.com',
    path: '/v1/services',
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${RENDER_API_KEY}`,
      'Content-Type': 'application/json'
    }
  };

  return new Promise((resolve, reject) => {
    const req = https.request(options, (res) => {
      let data = '';
      
      res.on('data', (chunk) => {
        data += chunk;
      });
      
      res.on('end', () => {
        if (res.statusCode === 201) {
          console.log('✅ Render 服务创建成功！');
          const service = JSON.parse(data);
          console.log(`服务 URL: ${service.service.serviceDetails.url}`);
          resolve(service);
        } else {
          console.error('❌ 部署失败:', data);
          reject(new Error(data));
        }
      });
    });

    req.on('error', (error) => {
      console.error('❌ 请求失败:', error);
      reject(error);
    });

    req.write(JSON.stringify(serviceConfig));
    req.end();
  });
}

deployToRender().catch(console.error);
```

---

## 第三步：创建一键部署脚本

### 3.1 完整的自动化部署脚本

创建 `deploy-all.js`：

```javascript
#!/usr/bin/env node

const { execSync } = require('child_process');
const fs = require('fs');
const https = require('https');

// 加载环境变量
require('dotenv').config({ path: '.env.local' });
require('dotenv').config({ path: 'worker/.env' });

console.log('🚀 YouTube MP3 Downloader - 自动化部署工具\n');

// 检查必需的环境变量
function checkEnvVars() {
  console.log('📋 检查环境变量...');
  
  const required = [
    'RAPIDAPI_KEY',
    'UPSTASH_REDIS_REST_URL',
    'UPSTASH_REDIS_REST_TOKEN',
    'R2_ENDPOINT',
    'R2_ACCESS_KEY_ID',
    'R2_SECRET_ACCESS_KEY',
    'R2_BUCKET_NAME',
    'R2_PUBLIC_URL'
  ];

  const missing = required.filter(key => !process.env[key]);
  
  if (missing.length > 0) {
    console.error('❌ 缺少必需的环境变量:');
    missing.forEach(key => console.error(`   - ${key}`));
    console.error('\n请在 .env.local 和 worker/.env 中配置这些变量');
    process.exit(1);
  }
  
  console.log('✅ 环境变量检查通过\n');
}

// 部署到 Vercel
async function deployVercel() {
  console.log('📦 部署到 Vercel...');
  
  try {
    // 检查是否已登录
    try {
      execSync('vercel whoami', { stdio: 'ignore' });
    } catch {
      console.log('请先登录 Vercel:');
      execSync('vercel login', { stdio: 'inherit' });
    }

    // 部署
    const result = execSync('vercel --prod --yes', { 
      encoding: 'utf-8',
      env: {
        ...process.env,
        RAPIDAPI_KEY: process.env.RAPIDAPI_KEY,
        RAPIDAPI_HOST_1: process.env.RAPIDAPI_HOST_1,
        RAPIDAPI_HOST_2: process.env.RAPIDAPI_HOST_2,
        RAPIDAPI_HOST_3: process.env.RAPIDAPI_HOST_3,
        UPSTASH_REDIS_REST_URL: process.env.UPSTASH_REDIS_REST_URL,
        UPSTASH_REDIS_REST_TOKEN: process.env.UPSTASH_REDIS_REST_TOKEN,
        RENDER_WORKER_URL: process.env.RENDER_WORKER_URL || 'https://youtube-mp3-worker.onrender.com',
        RAPIDAPI_1_MONTHLY_QUOTA: '300',
        RAPIDAPI_2_MONTHLY_QUOTA: '300',
        RAPIDAPI_3_DAILY_QUOTA: '500'
      }
    });

    const urlMatch = result.match(/https:\/\/[^\s]+/);
    const deployUrl = urlMatch ? urlMatch[0] : 'Unknown';
    
    console.log('✅ Vercel 部署成功！');
    console.log(`   URL: ${deployUrl}\n`);
    
    return deployUrl;
  } catch (error) {
    console.error('❌ Vercel 部署失败:', error.message);
    throw error;
  }
}

// 部署到 Render
async function deployRender() {
  console.log('📦 部署到 Render...');
  
  const RENDER_API_KEY = process.env.RENDER_API_KEY;
  
  if (!RENDER_API_KEY) {
    console.error('❌ 缺少 RENDER_API_KEY');
    console.error('请访问 https://dashboard.render.com/account/api-keys 获取 API Key');
    throw new Error('Missing RENDER_API_KEY');
  }

  const serviceConfig = {
    type: 'web_service',
    name: 'youtube-mp3-worker',
    env: 'docker',
    region: 'singapore',
    plan: 'free',
    dockerfilePath: './worker/Dockerfile',
    dockerContext: './worker',
    healthCheckPath: '/health',
    envVars: [
      { key: 'NODE_ENV', value: 'production' },
      { key: 'UPSTASH_REDIS_REST_URL', value: process.env.UPSTASH_REDIS_REST_URL },
      { key: 'UPSTASH_REDIS_REST_TOKEN', value: process.env.UPSTASH_REDIS_REST_TOKEN },
      { key: 'R2_ENDPOINT', value: process.env.R2_ENDPOINT },
      { key: 'R2_ACCESS_KEY_ID', value: process.env.R2_ACCESS_KEY_ID },
      { key: 'R2_SECRET_ACCESS_KEY', value: process.env.R2_SECRET_ACCESS_KEY },
      { key: 'R2_BUCKET_NAME', value: process.env.R2_BUCKET_NAME },
      { key: 'R2_PUBLIC_URL', value: process.env.R2_PUBLIC_URL },
      { key: 'MAX_CONCURRENT_TASKS', value: '3' },
      { key: 'TASK_TIMEOUT', value: '120000' },
      { key: 'PORT', value: '3000' }
    ]
  };

  return new Promise((resolve, reject) => {
    const data = JSON.stringify(serviceConfig);
    
    const options = {
      hostname: 'api.render.com',
      path: '/v1/services',
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${RENDER_API_KEY}`,
        'Content-Type': 'application/json',
        'Content-Length': data.length
      }
    };

    const req = https.request(options, (res) => {
      let responseData = '';
      
      res.on('data', (chunk) => {
        responseData += chunk;
      });
      
      res.on('end', () => {
        if (res.statusCode === 201) {
          const service = JSON.parse(responseData);
          console.log('✅ Render 部署成功！');
          console.log(`   服务 ID: ${service.service.id}`);
          console.log(`   服务 URL: ${service.service.serviceDetails.url}\n`);
          resolve(service.service.serviceDetails.url);
        } else if (res.statusCode === 409) {
          console.log('ℹ️  服务已存在，跳过创建');
          console.log('   URL: https://youtube-mp3-worker.onrender.com\n');
          resolve('https://youtube-mp3-worker.onrender.com');
        } else {
          console.error('❌ Render 部署失败:', responseData);
          reject(new Error(responseData));
        }
      });
    });

    req.on('error', (error) => {
      console.error('❌ 请求失败:', error.message);
      reject(error);
    });

    req.write(data);
    req.end();
  });
}

// 主函数
async function main() {
  try {
    // 1. 检查环境变量
    checkEnvVars();

    // 2. 部署到 Vercel
    const vercelUrl = await deployVercel();

    // 3. 部署到 Render
    const renderUrl = await deployRender();

    // 4. 显示总结
    console.log('🎉 部署完成！\n');
    console.log('📝 部署信息:');
    console.log(`   Frontend (Vercel): ${vercelUrl}`);
    console.log(`   Worker (Render):   ${renderUrl}`);
    console.log('\n⚠️  下一步:');
    console.log('   1. 更新 Vercel 环境变量 RENDER_WORKER_URL 为:', renderUrl);
    console.log('   2. 在 cron-job.org 设置 CRON 任务');
    console.log('   3. 测试部署: npm run test:e2e');

  } catch (error) {
    console.error('\n❌ 部署失败:', error.message);
    process.exit(1);
  }
}

// 运行
main();
```

### 3.2 添加到 package.json

```json
{
  "scripts": {
    "deploy": "node deploy-all.js",
    "deploy:vercel": "vercel --prod",
    "deploy:render": "node deploy-render.js",
    "test:e2e": "bash test-e2e.sh"
  },
  "devDependencies": {
    "dotenv": "^16.0.0"
  }
}
```

---

## 使用方法

### 一键部署

```bash
# 安装依赖
npm install

# 运行自动化部署
npm run deploy
```

### 分步部署

```bash
# 只部署 Vercel
npm run deploy:vercel

# 只部署 Render
npm run deploy:render
```

---

## 方案 2: 使用 GitHub Actions（如果你改变主意）

创建 `.github/workflows/deploy.yml`：

```yaml
name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-vercel:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

  deploy-render:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Deploy to Render
        run: |
          curl -X POST https://api.render.com/deploy/srv-xxx
```

---

## 故障排除

### Vercel CLI 问题

```bash
# 重新登录
vercel logout
vercel login

# 清除缓存
rm -rf .vercel
```

### Render API 问题

```bash
# 测试 API Key
curl -H "Authorization: Bearer $RENDER_API_KEY" \
  https://api.render.com/v1/services

# 查看现有服务
curl -H "Authorization: Bearer $RENDER_API_KEY" \
  https://api.render.com/v1/services | jq
```

---

## 总结

使用这些脚本，你可以：

1. ✅ 一键部署到 Vercel 和 Render
2. ✅ 自动配置所有环境变量
3. ✅ 无需手动在网页上操作
4. ✅ 可以集成到 CI/CD 流程

**推荐使用:** `deploy-all.js` 脚本，最简单最可靠！
